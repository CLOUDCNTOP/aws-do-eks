{
    "AWSTemplateFormatVersion" : "2010-09-09",
  
    "Description" : "AWS CloudFormation Sample Template for a Management Instance",
  
    "Mappings" : {
      "AWSRegion2AMI" : {
        "us-east-1"        : {"ami": "ami-00f44084952227ef0"},
        "us-east-2"        : {"ami": "ami-0a714e270d06489a9"},
        "us-west-1"        : {"ami": "ami-09d540cb66f1315ee"},
        "us-west-2"        : {"ami": "ami-0a20a878a1c1e5477"}
      }
    },
  
    "Resources" : {
  
      "ManagementInstance": {
        "Type": "AWS::EC2::Instance",
        "Properties": {
          "ImageId" : { "Fn::FindInMap" : [ "AWSRegion2AMI", { "Ref" : "AWS::Region" }, "ami" ] },
          "InstanceType"   : "m5.xlarge",
          "IamInstanceProfile" : {"Ref" : "RootInstanceProfile"},
          "SecurityGroups" : [ {"Ref" : "ManagementInstanceSecurityGroup"} ],
          "UserData"       : { "Fn::Base64" : { "Fn::Join" : ["", [
               "#!/bin/bash \n",
               "yum install -y aws-cfn-bootstrap git\n",
               "cd /home/ec2-user && git clone https://github.com/aws-samples/aws-do-eks.git && chown -R ec2-user:ec2-user /home/ec2-user && git config --global --add safe.directory /home/ec2-user/aws-do-eks && git checkout deepspeed\n",
               "bash -c /home/ec2-user/aws-do-eks/Container-Root/eks/ops/setup/install-aws-cli.sh\n",
               "bash -c /home/ec2-user/aws-do-eks/Container-Root/eks/ops/setup/install-eksctl.sh\n",
               "bash -c /home/ec2-user/aws-do-eks/Container-Root/eks/ops/setup/install-kubectl.sh\n",
               "bash -c /home/ec2-user/aws-do-eks/Container-Root/eks/ops/setup/install-kubectx.sh\n",
               "bash -c /home/ec2-user/aws-do-eks/Container-Root/eks/ops/setup/install-kubeps1.sh\n",
               "bash -c /home/ec2-user/aws-do-eks/Container-Root/eks/ops/setup/install-cloud9.sh\n",
               "/bin/su - ec2-user bash -c eksctl create cluster -f /home/ec2-user/aws-do-eks/Container-Root/eks/eks-kubeflow.yaml\n"
          ]]}}
        },
        "CreationPolicy" : {
        }
      },
  
     "RootRole": {
     "Type": "AWS::IAM::Role",
     "Properties": {
        "AssumeRolePolicyDocument": {
           "Version" : "2012-10-17",
           "Statement": [ {
              "Effect": "Allow",
              "Principal": {
                 "Service": [ "ec2.amazonaws.com" ]
              },
              "Action": [ "sts:AssumeRole" ]
           } ]
        },
        "Path": "/"
     }
      },
  
      "RolePolicies": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "root",
        "PolicyDocument": {
           "Version" : "2012-10-17",
           "Statement": [ {
              "Effect": "Allow",
              "Action": "*",
              "Resource": "*"
           } ]
        },
        "Roles": [ {
           "Ref": "RootRole"
        } ]
      }
      },
  
      "RootInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [ {
           "Ref": "RootRole"
        } ]
         }
       },
  
      "ManagementInstanceSecurityGroup" : {
        "Type" : "AWS::EC2::SecurityGroup",
        "Properties" : {
          "GroupDescription" : "Enable access to Management Instance",
          "SecurityGroupIngress" : [
            {"IpProtocol" : "tcp", "FromPort" : "443", "ToPort" : "443", "CidrIp" : "0.0.0.0/0"},
            {"IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0"}
          ]
        }
      }
  
    },
  
    "Outputs" : {
      "ManagementInstance_DNS_Name" : {
        "Description" : "Management Instance",
        "Value" : { "Fn::Join" : ["", ["", { "Fn::GetAtt" : [ "ManagementInstance", "PublicDnsName" ]}]] }
      },
      "ManagementInstance_SSM_Login" : {
        "Description" : "Session Manager Login",
        "Value": { "Fn::Join" : ["https://", { "Ref", "AWS::Region" }, ".console.aws.amazon.com/systems-manager/session-manager/", { "Fn::GetAtt" : [ "ManagementInstance", "InstanceId" ] }, "?region=", { "Ref", "AWS::Region"} }
      }
    }
  }

